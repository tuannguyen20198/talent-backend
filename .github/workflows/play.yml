name: Build and Deploy SSO

on:
  push:
    branches:
      - main
jobs:
  build-and-deploy-sso:
    name: Build & Deploy SSO Service
    runs-on: ubuntu-latest

    steps:
      - name: 🧾 Checkout repository
        uses: actions/checkout@v3

      - name: ⚙️ Setup Node.js 22.x
        uses: actions/setup-node@v3
        with:
          node-version: 22

      - name: 📦 Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: 📥 Install dependencies (sso only)
        run: pnpm install --filter @apps/sso-service...

      - name: 🛠️ Build SSO service
        run: pnpm build --filter @apps/sso-service...

      - name: 🔄 Run Prisma migrate (deploy)
        run: pnpm prisma:deploy:sso
        env:
          # Gán biến môi trường từ GitHub Secrets
          DATABASE_URL: ${{ secrets.SSO_DATABASE_URL }}

      # Tuỳ chọn: Start production (nếu self-host)
      # - name: 🚀 Start SSO service (prod)
      #   run: pnpm start:prod --filter @apps/sso-service
      #   env:
      #     NODE_ENV: production
      #     DATABASE_URL: ${{ secrets.SSO_DATABASE_URL }}

      # Hoặc deploy lên server
      # - name: 🚀 Deploy to production
      #   run: ./scripts/deploy-sso.sh
      #   env:
      #     DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
